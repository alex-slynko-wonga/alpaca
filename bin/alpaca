#!/usr/bin/env ruby
require 'gli'
require 'alpaca'
require 'alpaca/solution'
require 'alpaca/nuget'
require 'yaml'

include GLI::App

program_desc 'Custom build tool'

version Alpaca::Versioning.find.format '%M.%m.%p'

subcommand_option_handling :normal
arguments :strict

desc 'Initialize new solution'
arg_name 'Describe arguments to init here'
command :init do |c|
  c.desc 'Describe a switch to init'
  c.switch :s

  c.desc 'Describe a flag to init'
  c.default_value 'default'
  c.flag :f
  c.action do |global_options, options, args|
    puts "init command ran with #{global_options}, #{options}, #{args}"
  end
end

desc 'Compile solution'
arg_name 'solution_name'
command :compile do |c|
  c.desc 'Build solution in Debug mode'
  c.switch :d

  c.action do |_, options, args|
    conf = ('Debug' if options[:d]) || 'Release'
    args = ['**/*.sln'] if args == []
    args.each do |a|
      Dir.glob(a).each do |f|
        s = Alpaca::Solution.new(f)
        puts s.to_s
        packages_dir = File.join(File.dirname(s.file), '/packages')
        Alpaca::Nuget.new('d:/Nuget/Nuget.exe').restore s.file do
          configure(non_interactive: true)
          configure(config_file: 'd:/Nuget/Nuget.config')
          configure(verbosity: 'detailed')
          configure(output_directory: packages_dir)
        end
        s.compile do
          configure(targets: %w(Clean Rebuild), verbosity: 'minimal')
          configure(properties: { 'Configuration' => conf })
        end
      end
    end
  end
end

desc 'Test solution'
arg_name 'Describe arguments to test here'
command :test do |c|
  c.action do
    puts 'test command ran'
  end
end

desc 'Describe pack here'
arg_name 'Describe arguments to pack here'
command :pack do |c|
  c.action do
    puts 'pack command ran'
  end
end

desc 'Describe push here'
arg_name 'Describe arguments to push here'
command :push do |c|
  c.action do
    puts 'push command ran'
  end
end

desc 'Describe promote here'
arg_name 'Describe arguments to promote here'
command :promote do |c|
  c.action do
    puts 'promote command ran'
  end
end

desc 'Describe log here'
arg_name 'Describe arguments to log here'
command :log do |c|
  c.action do
    puts 'log command ran'
  end
end

desc 'Describe review here'
arg_name 'Describe arguments to review here'
command :review do |c|
  c.action do
    puts 'review command ran'
  end
end

exit run(ARGV)
